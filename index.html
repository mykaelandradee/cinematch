<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMatch | Recomendador Inteligente</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2503/2503508.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #4facfe; }
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: #fff; transition: background 0.8s ease; overflow-x: hidden; }
        #bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: blur(60px) brightness(0.3); z-index: -1; transition: background-image 1s ease-in-out; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .gradient-text { background: linear-gradient(135deg, #fff 0%, #4facfe 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .suggestion-item:hover { background: rgba(255, 255, 255, 0.1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.6s ease-out forwards; }
        .btn-glow:not(:disabled) { box-shadow: 0 0 20px rgba(79, 172, 254, 0.4); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; backdrop-filter: blur(15px); align-items: center; justify-content: center; padding: 20px; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        .toggle-btn { padding: 8px 20px; border-radius: 99px; font-size: 0.75rem; font-weight: 700; transition: all 0.3s ease; cursor: pointer; letter-spacing: 1px; }
        .toggle-btn.active { background: #fff; color: #000; }
        
        .mood-btn { padding: 8px 16px; border-radius: 12px; font-size: 11px; font-weight: 800; border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease; opacity: 0.4; }
        .mood-btn.active { opacity: 1; background: rgba(79, 172, 254, 0.2); border-color: #4facfe; color: #4facfe; }
        
        .genre-pill { padding: 6px 14px; border-radius: 99px; font-size: 10px; font-weight: 700; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); transition: all 0.3s; cursor: pointer; opacity: 0.6; }
        .genre-pill.active { background: #4facfe; color: black; opacity: 1; }
        
        @keyframes skeleton-pulse { 0% { opacity: 0.05; } 50% { opacity: 0.15; } 100% { opacity: 0.05; } }
        .skeleton { animation: skeleton-pulse 1.5s infinite ease-in-out; background: white; border-radius: 20px; }
        
        .fusion-anim-alpha { transform: translateX(50%) scale(0.5); opacity: 0; transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .fusion-anim-beta { transform: translateX(-50%) scale(0.5); opacity: 0; transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .provider-icon { width: 42px; height: 42px; border-radius: 10px; object-fit: cover; }

        #settings-drawer { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out, margin 0.5s ease; }
        #settings-drawer.open { max-height: 800px; margin-top: 2rem; margin-bottom: 2rem; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-6 text-center">

    <audio id="snd-process" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>
    <audio id="snd-success" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>

    <div id="bg-overlay"></div>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="max-w-4xl w-full glass p-8 md:p-12 rounded-[40px] animate-fade text-left relative overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
            <div id="modal-video-container" class="hidden mb-8 aspect-video rounded-3xl overflow-hidden border border-white/10 shadow-2xl">
                <iframe id="trailer-frame" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
            <h3 id="modal-title" class="text-4xl font-black mb-6 tracking-tighter"></h3>
            <p id="modal-desc" class="text-gray-300 text-lg leading-relaxed mb-10 font-light pr-4"></p>
            <div id="modal-extra-info" class="mb-10"></div>
            <button onclick="closeModal()" class="px-10 py-4 rounded-full bg-white text-black font-bold uppercase tracking-widest text-xs">Fechar</button>
        </div>
    </div>

    <div class="fixed top-6 right-6 z-[100] flex items-center gap-4">
        <div class="flex items-center bg-white/5 p-1 rounded-full border border-white/10 backdrop-blur-md">
            <div id="toggle-movie" class="toggle-btn active" onclick="setMediaType('movie')">FILMES</div>
            <div id="toggle-tv" class="toggle-btn" onclick="setMediaType('tv')">S√âRIES</div>
        </div>
        <select id="langSelect" onchange="updateLanguage()" class="bg-black/40 text-white border border-white/10 rounded-full px-4 py-2 text-xs font-bold focus:outline-none backdrop-blur-md cursor-pointer">
            <option value="pt-BR">PT-BR</option>
            <option value="en-US">EN-US</option>
        </select>
    </div>

    <div class="max-w-5xl w-full space-y-12 animate-fade pb-20">
        <header class="space-y-4">
            <h1 class="text-6xl font-extrabold tracking-tighter gradient-text">CineMatch</h1>
            <p id="ui-subtitle" class="text-gray-400 font-light text-xl tracking-wide">A fus√£o definitiva da s√©tima arte.</p>
        </header>

        <div class="grid md:grid-cols-2 gap-8 text-left">
            <div class="relative">
                <label id="ui-label-a" class="block text-xs font-bold uppercase tracking-[0.2em] text-blue-400 mb-3 ml-1">Origem Alpha</label>
                <input type="text" id="input1" oninput="searchMedia(this, 'results1')" placeholder="..." class="w-full p-5 rounded-3xl glass focus:outline-none focus:ring-1 focus:ring-white/30 text-lg relative z-20">
                <div id="results1" class="absolute z-[60] w-full mt-2 rounded-2xl glass overflow-hidden hidden"></div>
                <div id="selected1" class="mt-4 hidden p-5 rounded-3xl glass flex items-center gap-5 border-l-4 border-blue-500 transition-all duration-500"></div>
            </div>
            <div class="relative">
                <label id="ui-label-b" class="block text-xs font-bold uppercase tracking-[0.2em] text-blue-400 mb-3 ml-1">Origem Beta</label>
                <input type="text" id="input2" oninput="searchMedia(this, 'results2')" placeholder="..." class="w-full p-5 rounded-3xl glass focus:outline-none focus:ring-1 focus:ring-white/30 text-lg relative z-20">
                <div id="results2" class="absolute z-[60] w-full mt-2 rounded-2xl glass overflow-hidden hidden"></div>
                <div id="selected2" class="mt-4 hidden p-5 rounded-3xl glass flex items-center gap-5 border-l-4 border-blue-500 transition-all duration-500"></div>
            </div>
        </div>

        <div class="flex flex-col items-center">
            <button onclick="toggleDrawer()" class="text-[10px] font-black tracking-[0.3em] text-gray-500 hover:text-white transition-all uppercase">
                ‚öôÔ∏è <span id="ui-settings-btn">Ajustes de Alquimia</span> <span id="drawer-icon">‚Üì</span>
            </button>
            
            <div id="settings-drawer" class="w-full">
                <div class="glass p-8 rounded-[40px] space-y-10">
                    <div class="flex flex-col items-center gap-3">
                        <p id="ui-mood-label" class="text-[9px] font-black uppercase tracking-[0.3em] text-gray-500">Intensidade (Mood)</p>
                        <div class="flex gap-2">
                            <button onclick="setMood('blockbuster')" id="mood-blockbuster" class="mood-btn active">üçø <span id="ui-popcorn">MODO PIPOCA</span></button>
                            <button onclick="setMood('cult')" id="mood-cult" class="mood-btn">üé¨ <span id="ui-cult">MODO CULT</span></button>
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-center gap-3 border-t border-white/5 pt-6">
                        <p id="ui-genre-label" class="text-[9px] font-black uppercase tracking-[0.3em] text-gray-500">Estilo de Match</p>
                        <div id="genre-container" class="flex flex-wrap justify-center gap-2"></div>
                    </div>

                    <div class="flex flex-col items-center gap-3 border-t border-white/5 pt-6">
                        <p id="ui-era-label" class="text-[9px] font-black uppercase tracking-[0.3em] text-gray-500">√âpoca</p>
                        <div class="flex gap-2">
                            <button onclick="setEra('modern')" id="era-modern" class="mood-btn active">‚ö° <span id="ui-modern">MODERNOS</span></button>
                            <button onclick="setEra('classic')" id="era-classic" class="mood-btn">üìº <span id="ui-classic">NOST√ÅLGICOS</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col items-center pt-6">
            <button onclick="generateRecommendation()" id="btnMatch" disabled class="px-16 py-5 rounded-full bg-white text-black font-black text-xl btn-glow transition-all disabled:opacity-20 uppercase tracking-tighter">Encontrar Match</button>
        </div>

        <div id="skeletonMatch" class="hidden pt-16 mt-16 animate-fade">
            <div class="max-w-4xl mx-auto glass rounded-[40px] overflow-hidden flex flex-col md:flex-row h-[550px]">
                <div class="w-full md:w-[400px] skeleton h-full"></div>
                <div class="p-10 md:p-14 flex flex-col justify-center flex-grow space-y-6"><div class="h-4 w-24 skeleton"></div><div class="h-12 w-3/4 skeleton"></div><div class="h-24 w-full skeleton"></div></div>
            </div>
        </div>

        <div id="matchResult" class="hidden pt-16 border-t border-white/5 mt-16 animate-fade">
            <h2 id="ui-result-title" class="text-center text-xs font-bold tracking-[0.4em] uppercase mb-12 text-gray-500">Resultado da Alquimia</h2>
            <div id="matchCard" class="max-w-4xl mx-auto glass rounded-[40px] overflow-hidden flex flex-col md:flex-row shadow-2xl transition-all"></div>
        </div>

        <div id="historySection" class="hidden mt-20 pt-10 border-t border-white/5 animate-fade">
            <div class="flex justify-between items-center mb-8 px-4">
                <h3 id="historyTitle" class="text-[10px] font-black uppercase tracking-[0.4em] text-gray-600"></h3>
                <button onclick="clearHistory()" id="btnClear" class="text-red-500 text-[10px] font-bold tracking-widest uppercase opacity-60 hover:opacity-100 transition-all"></button>
            </div>
            <div id="historyContainer" class="flex flex-wrap justify-center gap-6"></div>
        </div>
    </div>

    <script>
        const API_KEY = '5740f1c60616c26f12f0970f109ab3fe'; 
        const IMG_URL = 'https://image.tmdb.org/t/p/w500';
        let movieA = null, movieB = null, mediaType = 'movie', currentMood = 'blockbuster', selectedGenre = null, currentEra = 'modern';

        const translations = {
            'pt-BR': { 
                subtitle: "A fus√£o definitiva da s√©tima arte.", labelA: "Origem Alpha", labelB: "Origem Beta", placeholder: "Busque...", btn: "ENCONTRAR MATCH", loading: "FUNDINDO...", resTitle: "Resultado da Alquimia", tag: "FUS√ÉO RECOMENDADA", readMore: "Sinopse Completa", watchTrailer: "Assistir Trailer", providers: "Assista em:", histMovie: "Alquimias de Filmes", histTv: "Alquimias de S√©ries", clear: "LIMPAR HIST√ìRICO",
                settingsBtn: "Ajustes de Alquimia", moodLabel: "Intensidade (Mood)", genreLabel: "Estilo de Match", eraLabel: "√âpoca", popcorn: "MODO PIPOCA", cult: "MODO CULT", modern: "MODERNOS", classic: "NOST√ÅLGICOS"
            },
            'en-US': { 
                subtitle: "The ultimate entertainment fusion.", labelA: "Source Alpha", labelB: "Source Beta", placeholder: "Search...", btn: "FIND MATCH", loading: "FUSING...", resTitle: "Alchemy Result", tag: "RECOMMENDED FUSION", readMore: "Full Synopsis", watchTrailer: "Watch Trailer", providers: "Watch on:", histMovie: "Movie Alchemies", histTv: "Series Alchemies", clear: "CLEAR HISTORY",
                settingsBtn: "Alchemy Settings", moodLabel: "Intensity (Mood)", genreLabel: "Match Style", eraLabel: "Era", popcorn: "BLOCKBUSTER", cult: "CULT MODE", modern: "MODERN", classic: "CLASSIC"
            }
        };

        const genresData = {
            'pt-BR': {
                movie: [ {id: 28, name: 'A√ß√£o'}, {id: 35, name: 'Com√©dia'}, {id: 18, name: 'Drama'}, {id: 27, name: 'Terror'}, {id: 10749, name: 'Romance'} ],
                tv: [ {id: 10759, name: 'A√ß√£o'}, {id: 35, name: 'Com√©dia'}, {id: 18, name: 'Drama'}, {id: 9648, name: 'Mist√©rio'}, {id: 10765, name: 'Sci-Fi'} ]
            },
            'en-US': {
                movie: [ {id: 28, name: 'Action'}, {id: 35, name: 'Comedy'}, {id: 18, name: 'Drama'}, {id: 27, name: 'Horror'}, {id: 10749, name: 'Romance'} ],
                tv: [ {id: 10759, name: 'Action'}, {id: 35, name: 'Comedy'}, {id: 18, name: 'Drama'}, {id: 9648, name: 'Mystery'}, {id: 10765, name: 'Sci-Fi'} ]
            }
        };

        window.onload = () => {
            const savedType = localStorage.getItem('mediaType') || 'movie';
            setMediaType(savedType, false);
            updateLanguage();
        };

        function toggleDrawer() {
            const d = document.getElementById('settings-drawer');
            const icon = document.getElementById('drawer-icon');
            d.classList.toggle('open');
            icon.innerText = d.classList.contains('open') ? '‚Üë' : '‚Üì';
            if(d.classList.contains('open')) renderGenres();
        }

        function setEra(era) {
            currentEra = era;
            document.querySelectorAll('[id^="era-"]').forEach(b => b.classList.remove('active'));
            document.getElementById(`era-${era}`).classList.add('active');
        }

        function setMood(mood) {
            currentMood = mood;
            document.querySelectorAll('#mood-blockbuster, #mood-cult').forEach(b => b.classList.remove('active'));
            document.getElementById(`mood-${mood}`).classList.add('active');
        }

        function toggleGenre(id) {
            if(selectedGenre === id) {
                selectedGenre = null;
                document.getElementById(`genre-${id}`).classList.remove('active');
            } else {
                if(selectedGenre) {
                    const el = document.getElementById(`genre-${selectedGenre}`);
                    if(el) el.classList.remove('active');
                }
                selectedGenre = id;
                document.getElementById(`genre-${id}`).classList.add('active');
            }
        }

        function setMediaType(type, shouldReset = true) {
            mediaType = type;
            localStorage.setItem('mediaType', type);
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`toggle-${type}`).classList.add('active');
            
            // RESET DE AJUSTES AO TROCAR TIPO (NOVO)
            selectedGenre = null;
            setMood('blockbuster');
            setEra('modern');
            
            renderGenres();
            
            if(shouldReset) {
                movieA = null; movieB = null;
                document.querySelectorAll('input').forEach(i => { i.classList.remove('hidden'); i.value = ''; });
                document.querySelectorAll('[id^="selected"]').forEach(s => s.classList.add('hidden'));
                document.getElementById('matchResult').classList.add('hidden');
                document.getElementById('bg-overlay').style.backgroundImage = 'none';
            }
            renderHistory();
            checkButtonState();
        }

        function renderGenres() {
            const lang = document.getElementById('langSelect').value;
            const container = document.getElementById('genre-container');
            if(!container) return;
            const list = genresData[lang][mediaType];
            container.innerHTML = list.map(g => `
                <button onclick="toggleGenre(${g.id})" id="genre-${g.id}" class="genre-pill ${selectedGenre === g.id ? 'active' : ''}">
                    ${g.name.toUpperCase()}
                </button>
            `).join('');
        }

        async function searchMedia(input, resultDivId) {
            const lang = document.getElementById('langSelect').value;
            const query = input.value;
            const resDiv = document.getElementById(resultDivId);
            if (query.length < 3) { resDiv.classList.add('hidden'); return; }
            const response = await fetch(`https://api.themoviedb.org/3/search/${mediaType}?api_key=${API_KEY}&query=${encodeURIComponent(query)}&language=${lang}`);
            const data = await response.json();
            resDiv.innerHTML = ''; resDiv.classList.remove('hidden');
            data.results.slice(0, 5).forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggestion-item p-4 flex items-center gap-4 cursor-pointer border-b border-white/5';
                div.innerHTML = `<img src="${item.poster_path ? 'https://image.tmdb.org/t/p/w92' + item.poster_path : ''}" class="w-10 h-14 rounded-lg object-cover"><div class="text-left font-bold text-sm text-white">${item.title || item.name}</div>`;
                div.onclick = () => selectMedia(item, input.id, resultDivId);
                resDiv.appendChild(div);
            });
        }

        function selectMedia(item, inputId, resultDivId) {
            const isA = inputId === 'input1';
            if(isA) movieA = item; else movieB = item;
            const targetDiv = document.getElementById(isA ? 'selected1' : 'selected2');
            document.getElementById(inputId).classList.add('hidden');
            if(document.getElementById(resultDivId)) document.getElementById(resultDivId).classList.add('hidden');
            targetDiv.classList.remove('hidden', 'fusion-anim-alpha', 'fusion-anim-beta', 'opacity-0');
            targetDiv.innerHTML = `<img src="https://image.tmdb.org/t/p/w92${item.poster_path}" class="w-16 h-20 rounded-xl shadow-2xl"><div class="flex-grow text-left"><div class="text-xl font-black">${item.title || item.name}</div><button onclick="resetSelection('${inputId}')" class="text-xs text-blue-400 font-bold uppercase mt-1">Trocar</button></div>`;
            document.getElementById('bg-overlay').style.backgroundImage = `url(https://image.tmdb.org/t/p/w1280${item.poster_path})`;
            checkButtonState();
        }

        function resetSelection(inputId) {
            const isA = inputId === 'input1';
            document.getElementById(inputId).classList.remove('hidden'); document.getElementById(inputId).value = '';
            document.getElementById(isA ? 'selected1' : 'selected2').classList.add('hidden');
            if(isA) movieA = null; else movieB = null;
            checkButtonState();
        }

        function checkButtonState() { document.getElementById('btnMatch').disabled = !(movieA && movieB); }

        function updateLanguage() {
            const lang = document.getElementById('langSelect').value;
            const t = translations[lang] || translations['pt-BR'];
            
            document.getElementById('ui-subtitle').innerText = t.subtitle;
            document.getElementById('ui-label-a').innerText = t.labelA;
            document.getElementById('ui-label-b').innerText = t.labelB;
            document.getElementById('btnMatch').innerText = t.btn;
            document.getElementById('ui-result-title').innerText = t.resTitle;
            document.getElementById('btnClear').innerText = t.clear;
            document.getElementById('ui-settings-btn').innerText = t.settingsBtn;
            document.getElementById('ui-mood-label').innerText = t.moodLabel;
            document.getElementById('ui-genre-label').innerText = t.genreLabel;
            document.getElementById('ui-era-label').innerText = t.eraLabel;
            document.getElementById('ui-popcorn').innerText = t.popcorn;
            document.getElementById('ui-cult').innerText = t.cult;
            document.getElementById('ui-modern').innerText = t.modern;
            document.getElementById('ui-classic').innerText = t.classic;
            
            document.querySelectorAll('input').forEach(i => i.placeholder = t.placeholder);
            renderGenres();
            renderHistory();
        }

        async function fetchExtra(id, type) {
            const lang = document.getElementById('langSelect').value;
            const [v, p] = await Promise.all([
                fetch(`https://api.themoviedb.org/3/${type}/${id}/videos?api_key=${API_KEY}&language=${lang}`).then(r => r.json()),
                fetch(`https://api.themoviedb.org/3/${type}/${id}/watch/providers?api_key=${API_KEY}`).then(r => r.json())
            ]);
            return { trailer: v.results.find(vid => vid.type === 'Trailer' && vid.site === 'YouTube')?.key, providers: p.results?.BR?.flatrate || [] };
        }

        async function openModal(id, type, forceVideo = false) {
            const lang = document.getElementById('langSelect').value;
            const res = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${API_KEY}&language=${lang}`).then(r => r.json());
            const details = await fetchExtra(id, type);
            document.getElementById('modal-title').innerText = res.title || res.name;
            document.getElementById('modal-desc').innerText = res.overview || "...";
            const cont = document.getElementById('modal-video-container');
            const frame = document.getElementById('trailer-frame');
            if (forceVideo && details.trailer) { cont.classList.remove('hidden'); frame.src = `https://www.youtube.com/embed/${details.trailer}?autoplay=1`; }
            else { cont.classList.add('hidden'); frame.src = ""; }
            const extra = document.getElementById('modal-extra-info');
            extra.innerHTML = `<div class="flex flex-wrap gap-4">${details.providers.map(x => `<img src="https://image.tmdb.org/t/p/original${x.logo_path}" class="provider-icon">`).join('')}</div>`;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; document.getElementById('trailer-frame').src = ""; }

        function saveToHistory(item) {
            const key = `cineHistory_${mediaType}`;
            let h = JSON.parse(localStorage.getItem(key) || '[]');
            if (!h.find(m => m.id === item.id)) {
                h.unshift({id: item.id, title: item.title || item.name, poster_path: item.poster_path, type: mediaType});
                if (h.length > 5) h.pop();
                localStorage.setItem(key, JSON.stringify(h));
                renderHistory();
            }
        }

        function clearHistory() { if(confirm("Limpar hist√≥rico?")) { localStorage.removeItem(`cineHistory_${mediaType}`); renderHistory(); } }

        function renderHistory() {
            const key = `cineHistory_${mediaType}`;
            const h = JSON.parse(localStorage.getItem(key) || '[]');
            const container = document.getElementById('historyContainer');
            const section = document.getElementById('historySection');
            const title = document.getElementById('historyTitle');
            const lang = document.getElementById('langSelect').value;
            const t = translations[lang] || translations['pt-BR'];
            if (h.length > 0) {
                section.classList.remove('hidden');
                title.innerText = mediaType === 'movie' ? t.histMovie : t.histTv;
                container.innerHTML = h.map(m => `
                    <div class="cursor-pointer group text-center" onclick="openModal(${m.id}, '${m.type}', true)">
                        <img src="${IMG_URL}${m.poster_path}" class="w-24 h-36 rounded-xl glass border border-white/5 hover:scale-105 transition-all object-cover">
                        <p class="text-[9px] mt-2 font-bold text-gray-400 w-24 truncate uppercase tracking-tighter">${m.title}</p>
                    </div>`).join('');
            } else section.classList.add('hidden');
        }

        async function generateRecommendation() {
            const lang = document.getElementById('langSelect').value;
            const t = translations[lang] || translations['pt-BR'];
            const btn = document.getElementById('btnMatch');
            btn.disabled = true; btn.innerText = t.loading;

            document.getElementById('snd-process').play();
            document.getElementById('selected1').classList.add('fusion-anim-alpha');
            document.getElementById('selected2').classList.add('fusion-anim-beta');
            document.getElementById('matchResult').classList.add('hidden');
            document.getElementById('skeletonMatch').classList.remove('hidden');

            try {
                const [kwA, kwB] = await Promise.all([
                    fetch(`https://api.themoviedb.org/3/${mediaType}/${movieA.id}/keywords?api_key=${API_KEY}`).then(r => r.json()),
                    fetch(`https://api.themoviedb.org/3/${mediaType}/${movieB.id}/keywords?api_key=${API_KEY}`).then(r => r.json())
                ]);
                const keys = [...(kwA.keywords || kwA.results || []), ...(kwB.keywords || kwB.results || [])].map(k => k.id).slice(0, 10).join('|');
                
                let url = `https://api.themoviedb.org/3/discover/${mediaType}?api_key=${API_KEY}&with_keywords=${keys}&language=${lang}&exclude_ids=${movieA.id},${movieB.id}`;
                if(selectedGenre) url += `&with_genres=${selectedGenre}`;
                const dateParam = mediaType === 'movie' ? 'primary_release_date' : 'first_air_date';
                url += currentEra === 'modern' ? `&${dateParam}.gte=2010-01-01` : `&${dateParam}.lte=2009-12-31`;

                if (currentMood === 'blockbuster') url += `&sort_by=popularity.desc&vote_count.gte=500`;
                else url += `&sort_by=vote_average.desc&vote_count.gte=100&popularity.lte=50&vote_average.gte=7.0`;

                const disc = await fetch(url).then(r => r.json());
                const f = disc.results[Math.floor(Math.random() * Math.min(disc.results.length, 10))];

                setTimeout(() => {
                    document.getElementById('skeletonMatch').classList.add('hidden');
                    if (f) { document.getElementById('snd-success').play(); saveToHistory(f); showRecommendation(f); }
                    document.getElementById('selected1').classList.remove('fusion-anim-alpha');
                    document.getElementById('selected2').classList.remove('fusion-anim-beta');
                    btn.disabled = false; btn.innerText = t.btn;
                }, 1000);
            } catch(e) { btn.disabled = false; }
        }

        async function showRecommendation(f) {
            const t = translations[document.getElementById('langSelect').value] || translations['pt-BR'];
            const details = await fetchExtra(f.id, mediaType);
            const matchResultDiv = document.getElementById('matchResult');
            matchResultDiv.classList.remove('hidden');
            document.getElementById('matchCard').innerHTML = `
                <img src="${IMG_URL}${f.poster_path}" class="w-full md:w-[400px] object-cover h-[550px]">
                <div class="p-10 md:p-14 flex flex-col justify-center text-left flex-grow">
                    <span class="text-blue-400 text-sm font-black uppercase tracking-[0.3em] mb-4">${t.tag}</span>
                    <h3 class="text-5xl font-black mb-6 leading-none tracking-tighter">${f.title || f.name}</h3>
                    <p class="text-gray-300 text-lg leading-relaxed mb-4 font-light">${f.overview ? f.overview.substring(0, 220) + '...' : ''}</p>
                    <button onclick="openModal(${f.id}, '${mediaType}')" class="text-blue-400 font-bold uppercase tracking-widest text-xs mb-8">${t.readMore} +</button>
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="px-6 py-3 rounded-2xl bg-white/10 font-bold text-xl">‚≠ê ${f.vote_average?.toFixed(1)}</div>
                        ${details.trailer ? `<button onclick="openModal(${f.id}, '${mediaType}', true)" class="btn-play px-7 py-3 rounded-2xl font-bold flex items-center gap-3">‚ñ∂ ${t.watchTrailer}</button>` : ''}
                    </div>
                </div>`;
            window.scrollTo({ top: matchResultDiv.offsetTop - 50, behavior: 'smooth' });
            document.getElementById('bg-overlay').style.backgroundImage = `url(https://image.tmdb.org/t/p/w1280${f.poster_path})`;
        }
    </script>
</body>
</html>
